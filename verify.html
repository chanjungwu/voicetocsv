<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–‹é€šè»Ÿé«” - èªéŸ³æ§åˆ¶CSVä¿®æ”¹ç³»çµ±</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        /* é¡å¤–åŠ å…¥ä¸»é¡Œåˆ‡æ›æŒ‰éˆ•çš„æ¨£å¼ï¼Œä»¥é˜² style.css æœªåŒ…å« */
        .theme-toggle {
            position: fixed; top: 20px; right: 20px; background-color: var(--card-color); border: 2px solid var(--border-color);
            border-radius: 50px; padding: 10px 15px; cursor: pointer; font-size: 18px; transition: all 0.3s ease; z-index: 1000;
        }
        /* å®šç¾©äº®è‰²ä¸»é¡Œ */
        [data-theme="light"] {
            --bg-color: #ffffff; --card-color: #f8f9fa; --primary-text: #212529; --secondary-text: #6c757d;
            --accent-color: #ffc107; --accent-text: #000000; --success-color: #28a745; --error-color: #dc3545;
            --border-color: #dee2e6; --input-bg: #ffffff;
        }
        [data-theme="light"] .result-card.error { background-color: rgba(220, 53, 69, 0.1); border: 1px solid var(--error-color); }
    </style>
</head>
<body>
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="åˆ‡æ›æ˜æš—ä¸»é¡Œ">â˜€ï¸</button>
    <div class="container">
        <header class="header">
            <h1>ğŸš€ è»Ÿé«”å•Ÿç”¨é©—è­‰</h1>
            <p>è«‹è¼¸å…¥æ‚¨çš„åŒ¯æ¬¾è³‡è¨Šä»¥å®Œæˆé©—è­‰ï¼Œä¸¦å–å¾—å•Ÿç”¨ç¢¼ã€‚</p>
        </header>

        <main>
            <div class="card">
                <form id="verify-form">
                    <div class="form-group">
                        <label for="amount">åŒ¯æ¬¾é‡‘é¡ (NT$)</label>
                        <input type="number" id="amount" name="amount" placeholder="ä¾‹å¦‚ï¼š285" required>
                    </div>
                    
                    <div class="form-group" id="coupon-group" style="display: none;">
                        <label for="coupon">æ‚¨çš„å„ªæƒ ç¢¼</label>
                        <input type="text" id="coupon" name="coupon" placeholder="è«‹è¼¸å…¥æ‚¨ä½¿ç”¨çš„å„ªæƒ ç¢¼" required>
                    </div>

                    <div class="form-group-inline">
                        <div class="form-group">
                            <label for="date">åŒ¯æ¬¾æ—¥æœŸ</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label for="time">åŒ¯æ¬¾æ™‚é–“ (24å°æ™‚åˆ¶)</label>
                            <input type="text" id="time" name="time" pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]" placeholder="æ ¼å¼ HH:MM" required>
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="account">æ‚¨çš„åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</label>
                        <input type="text" id="account" name="account" pattern="\d{5}" title="è«‹è¼¸å…¥5ä½æ•¸å­—" placeholder="ç”¨æ–¼å‚™æ ¸ï¼Œè«‹å‹™å¿…å¡«å¯«" required>
                    </div>
                    <div class="form-group">
                        <label for="email">æ‚¨çš„ Email åœ°å€</label>
                        <input type="email" id="email" name="email" placeholder="ç”¨æ–¼æ¥æ”¶å•Ÿç”¨ç¢¼å‚™ä»½" required>
                    </div>

                    <button type="submit" id="submit-button">é©—è­‰ä¸¦å–å¾—å•Ÿç”¨ç¢¼</button>
                </form>
            </div>

            <div id="result" class="result-card" style="display: none;"></div>
        </main>
    </div>

    <script>
        const form = document.getElementById('verify-form');
        const submitButton = document.getElementById('submit-button');
        const resultDiv = document.getElementById('result');
        const amountInput = document.getElementById('amount');
        const couponGroup = document.getElementById('coupon-group');
        const couponInput = document.getElementById('coupon');
        const timeInput = document.getElementById('time');

        const discountedAmounts = [45, 255, 485];

        amountInput.addEventListener('input', () => {
            const amount = parseInt(amountInput.value, 10);
            if (discountedAmounts.includes(amount)) {
                couponGroup.style.display = 'block';
                couponInput.required = true;
            } else {
                couponGroup.style.display = 'none';
                couponInput.required = false;
            }
        });

        timeInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length > 2) {
                value = value.substring(0, 2) + ':' + value.substring(2, 4);
            }
            e.target.value = value;
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            submitButton.disabled = true;
            submitButton.textContent = 'é©—è­‰ä¸­...';
            resultDiv.style.display = 'none';

            const formData = {
                amount: amountInput.value,
                date: document.getElementById('date').value,
                time: timeInput.value,
                account: document.getElementById('account').value,
                email: document.getElementById('email').value,
                coupon: couponInput.required ? couponInput.value.trim().toUpperCase() : null
            };

            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });
                const data = await response.json();
                if (response.ok) {
                    resultDiv.className = 'result-card success';
                    resultDiv.innerHTML = `<h3>âœ… é©—è­‰æˆåŠŸï¼</h3><p>é€™æ˜¯æ‚¨çš„å°ˆå±¬å•Ÿç”¨ç¢¼ï¼Œè«‹å¦¥å–„ä¿ç®¡ï¼š</p><div class="activation-code">${data.activationCode}</div><p class="small-text">æˆ‘å€‘ä¹Ÿå°‡å•Ÿç”¨ç¢¼å¯„é€è‡³æ‚¨çš„Emailä¿¡ç®±ä½œç‚ºå‚™ä»½ã€‚</p>`;
                } else {
                    throw new Error(data.error || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤');
                }
            } catch (error) {
                resultDiv.className = 'result-card error';
                resultDiv.innerHTML = `<h3>âŒ é©—è­‰å¤±æ•—</h3><p>${error.message}</p><p class="small-text">è«‹æª¢æŸ¥æ‚¨è¼¸å…¥çš„è³‡æ–™æ˜¯å¦èˆ‡åŒ¯æ¬¾ç´€éŒ„å®Œå…¨ç›¸ç¬¦ã€‚å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹è¯ç¹«å®¢æœã€‚</p>`;
            } finally {
                resultDiv.style.display = 'block';
                submitButton.disabled = false;
                submitButton.textContent = 'é©—è­‰ä¸¦å–å¾—å•Ÿç”¨ç¢¼';
                resultDiv.scrollIntoView({ behavior: 'smooth' });
            }
        });

        // ä¸»é¡Œåˆ‡æ›åŠŸèƒ½
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            if (body.getAttribute('data-theme') === 'light') {
                body.removeAttribute('data-theme');
                if(themeToggle) themeToggle.textContent = 'ğŸŒ™';
                localStorage.setItem('theme', 'dark');
            } else {
                body.setAttribute('data-theme', 'light');
                if(themeToggle) themeToggle.textContent = 'â˜€ï¸';
                localStorage.setItem('theme', 'light');
            }
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥å„²å­˜çš„ä¸»é¡Œè¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            const themeToggle = document.getElementById('themeToggle');
            
            if (savedTheme === 'dark') {
                document.body.removeAttribute('data-theme');
                if(themeToggle) themeToggle.textContent = 'ğŸŒ™';
            } else {
                document.body.setAttribute('data-theme', 'light');
                if(themeToggle) themeToggle.textContent = 'â˜€ï¸';
            }
        });
    </script>
</body>
</html>