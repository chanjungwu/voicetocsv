<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–‹é€šè»Ÿé«” - èªéŸ³æ§åˆ¶CSVä¿®æ”¹ç³»çµ±</title>
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body data-theme="dark">
    <div class="container">
        <header class="header">
            <h1>ğŸš€ è»Ÿé«”å•Ÿç”¨é©—è­‰</h1>
            <p>è«‹è¼¸å…¥æ‚¨çš„åŒ¯æ¬¾è³‡è¨Šä»¥å®Œæˆé©—è­‰ï¼Œä¸¦å–å¾—å•Ÿç”¨ç¢¼ã€‚</p>
        </header>

        <main>
            <div class="card">
                <form id="verify-form">
                    <div class="form-group">
                        <label for="amount">åŒ¯æ¬¾é‡‘é¡ (NT$)</label>
                        <input type="number" id="amount" name="amount" placeholder="ä¾‹å¦‚ï¼š285" required>
                    </div>
                    
                    <!-- ã€æ–°å¢ã€‘å„ªæƒ ç¢¼è¼¸å…¥æ¡† (é è¨­éš±è—) -->
                    <div class="form-group" id="coupon-group" style="display: none;">
                        <label for="coupon">æ‚¨çš„å„ªæƒ ç¢¼</label>
                        <input type="text" id="coupon" name="coupon" placeholder="è«‹è¼¸å…¥æ‚¨ä½¿ç”¨çš„å„ªæƒ ç¢¼" required>
                    </div>

                    <div class="form-group-inline">
                        <div class="form-group">
                            <label for="date">åŒ¯æ¬¾æ—¥æœŸ</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label for="time">åŒ¯æ¬¾æ™‚é–“ (24å°æ™‚åˆ¶)</label>
                            <input type="text" id="time" name="time" pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]" placeholder="æ ¼å¼ HH:MM" required>
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="account">æ‚¨çš„åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</label>
                        <input type="text" id="account" name="account" pattern="\d{5}" title="è«‹è¼¸å…¥5ä½æ•¸å­—" placeholder="ç”¨æ–¼å‚™æ ¸ï¼Œè«‹å‹™å¿…å¡«å¯«" required>
                    </div>
                    <div class="form-group">
                        <label for="email">æ‚¨çš„ Email åœ°å€</label>
                        <input type="email" id="email" name="email" placeholder="ç”¨æ–¼æ¥æ”¶å•Ÿç”¨ç¢¼å‚™ä»½" required>
                    </div>

                    <button type="submit" id="submit-button">é©—è­‰ä¸¦å–å¾—å•Ÿç”¨ç¢¼</button>
                </form>
            </div>

            <div id="result" class="result-card" style="display: none;"></div>
        </main>
    </div>

    <script>
        const form = document.getElementById('verify-form');
        const submitButton = document.getElementById('submit-button');
        const resultDiv = document.getElementById('result');
        const amountInput = document.getElementById('amount');
        const couponGroup = document.getElementById('coupon-group');
        const couponInput = document.getElementById('coupon');
        const timeInput = document.getElementById('time');

        // ã€æ–°å¢ã€‘å„ªæƒ åƒ¹åˆ—è¡¨
        const discountedAmounts = [45, 255, 485];

        // ã€æ–°å¢ã€‘ç›£è½é‡‘é¡è¼¸å…¥ï¼Œæ±ºå®šæ˜¯å¦é¡¯ç¤ºå„ªæƒ ç¢¼æ¬„ä½
        amountInput.addEventListener('input', () => {
            const amount = parseInt(amountInput.value, 10);
            if (discountedAmounts.includes(amount)) {
                couponGroup.style.display = 'block';
                couponInput.required = true;
            } else {
                couponGroup.style.display = 'none';
                couponInput.required = false;
            }
        });

        // è‡ªå‹•æ ¼å¼åŒ–æ™‚é–“è¼¸å…¥
        timeInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length > 2) {
                value = value.substring(0, 2) + ':' + value.substring(2, 4);
            }
            e.target.value = value;
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            submitButton.disabled = true;
            submitButton.textContent = 'é©—è­‰ä¸­...';
            resultDiv.style.display = 'none';

            const formData = {
                amount: amountInput.value,
                date: document.getElementById('date').value,
                time: timeInput.value,
                account: document.getElementById('account').value,
                email: document.getElementById('email').value,
                // ã€æ–°å¢ã€‘å¦‚æœå„ªæƒ ç¢¼æ¬„ä½å¯è¦‹ï¼Œå°±å°‡å…¶å€¼åŠ å…¥
                coupon: couponInput.required ? couponInput.value.trim().toUpperCase() : null
            };

            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result-card success';
                    resultDiv.innerHTML = `
                        <h3>âœ… é©—è­‰æˆåŠŸï¼</h3>
                        <p>é€™æ˜¯æ‚¨çš„å°ˆå±¬å•Ÿç”¨ç¢¼ï¼Œè«‹å¦¥å–„ä¿ç®¡ï¼š</p>
                        <div class="activation-code">${data.activationCode}</div>
                        <p class="small-text">æˆ‘å€‘ä¹Ÿå°‡å•Ÿç”¨ç¢¼å¯„é€è‡³æ‚¨çš„Emailä¿¡ç®±ä½œç‚ºå‚™ä»½ã€‚</p>
                    `;
                } else {
                    throw new Error(data.error || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤');
                }
            } catch (error) {
                resultDiv.className = 'result-card error';
                resultDiv.innerHTML = `
                    <h3>âŒ é©—è­‰å¤±æ•—</h3>
                    <p>${error.message}</p>
                    <p class="small-text">è«‹æª¢æŸ¥æ‚¨è¼¸å…¥çš„è³‡æ–™æ˜¯å¦èˆ‡åŒ¯æ¬¾ç´€éŒ„å®Œå…¨ç›¸ç¬¦ã€‚å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹è¯ç¹«å®¢æœã€‚</p>
                `;
            } finally {
                resultDiv.style.display = 'block';
                submitButton.disabled = false;
                submitButton.textContent = 'é©—è­‰ä¸¦å–å¾—å•Ÿç”¨ç¢¼';
                resultDiv.scrollIntoView({ behavior: 'smooth' });
            }
        });
    </script>
</body>
</html>